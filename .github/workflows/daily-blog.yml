# =============================================================================
# BIOBUILDS Daily Blog Post Generator â€” v4.5 (Multi-language)
# =============================================================================
#
# Architecture:
#   Three sequential Claude runs produce the SAME topic adapted for each locale:
#   1. EN: Picks topic, writes English version (international audience)
#   2. DE: Reads EN article, adapts for DACH (Germany/Austria focus)
#   3. RO: Reads EN article, adapts for Romanian audience
#   All git operations are deterministic workflow steps after Claude finishes.
#
# SETUP:
#   1. Run `claude setup-token` locally â†’ copy the token
#   2. Repo â†’ Settings â†’ Secrets â†’ Actions â†’ New repository secret:
#      Name:  CLAUDE_CODE_OAUTH_TOKEN
#      Value: (paste token from step 1)
#   3. Place this file at: .github/workflows/daily-blog.yml
#   4. Merge to default branch (schedule only fires from default branch)
#   5. Test: Actions tab â†’ "Daily Blog Post" â†’ Run workflow
#
# SECURITY:
#   - Actions pinned to full 40-char commit SHAs
#   - Permissions: contents:write + pull-requests:write + id-token:write
#   - OAuth token = high-value credential â†’ rotate every 60â€“90 days
#   - Trigger: schedule + workflow_dispatch only (no PR/fork triggers)
# =============================================================================

name: Daily Blog Post

on:
  schedule:
    - cron: '0 2 * * *'           # 2:00 UTC â‰ˆ 04:00 EET / 05:00 EEST
  workflow_dispatch:                # manual trigger from Actions tab

permissions:
  contents: write
  pull-requests: write
  id-token: write

# Prevent concurrent runs from conflicting
concurrency:
  group: daily-blog
  cancel-in-progress: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Write English article (picks the topic)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  write-en:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Generate English article
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are the BIOBUILDS blog content engine.
            Your job: write ONE new blog post in ENGLISH and save it to disk.

            â–ˆâ–ˆ  DO NOT run any git commands.
            â–ˆâ–ˆ  DO NOT create branches, commits, or pull requests.

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            PHASE 1 â€” RECONNAISSANCE
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            1. Read CLAUDE.md for complete instructions
            2. Read SEO.md for keyword strategy and content rules
            3. Read SOURCES.md â€” your research database
            4. Count articles per pillar in EN/ directory
            5. Pick the pillar with the FEWEST articles
            6. Read 2-3 existing EN articles to match format exactly
            7. Read blog-styles.css â€” use ONLY existing classes

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            PHASE 2 â€” RESEARCH
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            8. Start with SOURCES.md â€” pick 3-5 relevant sources
            9. Use WebFetch to extract real data from those sources
            10. Use WebSearch for additional sources (2025-2026 data welcome)
            11. You CAN use sources beyond SOURCES.md â€” just ensure they're
                high-authority (.gov, .edu, peer-reviewed, reputable orgs, etc.)
                Prefer European sources where possible
            12. Cross-reference statistics across multiple sources

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            PHASE 3 â€” WRITE ENGLISH VERSION
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            13. Pick a topic that:
                - Is NOT already covered by existing articles
                - Targets a keyword from SEO.md
                - Has sufficient source material

            14. Write the article in ENGLISH:
                - Match existing article format exactly
                - Include Schema.org JSON-LD markup
                - Use only bb-* CSS classes from blog-styles.css
                - 2,000-3,000 words
                - Every statistic backed by a source
                - International/EU perspective (can mention all markets)

            15. Save to EN/ directory using naming convention:
                {Pillar}.{SubArticle} EN {url-slug}.html
                Example: 3.3 EN timber-frame-insulation-guide.html

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            RULES
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            - NEVER run git commands
            - NEVER invent statistics
            - NEVER use CSS classes not in blog-styles.css
            - NEVER duplicate existing topics

          claude_args: |
            --max-turns 25
            --model claude-opus-4-5-20251101
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Upload EN workspace
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: workspace-en
          path: |
            EN/
            DE/
            RO/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Write German article (adapt from EN for DACH audience)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  write-de:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: write-en

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Download EN workspace
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: workspace-en
          path: .

      - name: Generate German article
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are the BIOBUILDS blog content engine.
            Write the GERMAN version of today's blog post for DACH audience.

            â–ˆâ–ˆ  DO NOT run any git commands.

            STEPS:
            1. List files in EN/ â€” find the NEWEST .html file (today's article)
            2. Read that EN article completely
            3. Read MARKETS.md â†’ follow DACH market section exactly
            4. Read CLAUDE.md â†’ formatting requirements
            5. Read 2-3 existing DE articles â†’ match German tone/style
            6. Translate and ADAPT the EN article per MARKETS.md
            7. Save to DE/ with SAME pillar.subarticle AND same slug as EN:
               Example: EN has "3.3 EN timber-frame-insulation-guide.html"
                     â†’ Save as "3.3 DE timber-frame-insulation-guide.html"

            RULES:
            - Match EN article's pillar, subarticle, AND slug exactly
            - Only change "EN" to "DE" in filename
            - Follow MARKETS.md localization requirements
            - Write natural German, not literal translation
            - Update inLanguage to "de" in Schema.org
            - NEVER run git commands

          claude_args: |
            --max-turns 25
            --model claude-opus-4-5-20251101
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Upload DE workspace
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: workspace-de
          path: |
            EN/
            DE/
            RO/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Write Romanian article (adapt from EN for Romanian audience)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  write-ro:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: write-de

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Download DE workspace
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: workspace-de
          path: .

      - name: Generate Romanian article
        uses: anthropics/claude-code-action@01e756b34ef7a1447e9508f674143b07d20c2631
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            You are the BIOBUILDS blog content engine.
            Write the ROMANIAN version of today's blog post for Romanian audience.

            â–ˆâ–ˆ  DO NOT run any git commands.

            STEPS:
            1. List files in EN/ â€” find the NEWEST .html file (today's article)
            2. Read that EN article completely
            3. Read MARKETS.md â†’ follow Romania market section exactly
            4. Read CLAUDE.md â†’ formatting requirements
            5. Read 2-3 existing RO articles â†’ match Romanian tone/style
            6. Translate and ADAPT the EN article per MARKETS.md
            7. Save to RO/ with SAME pillar.subarticle AND same slug as EN:
               Example: EN has "3.3 EN timber-frame-insulation-guide.html"
                     â†’ Save as "3.3 RO timber-frame-insulation-guide.html"

            RULES:
            - Match EN article's pillar, subarticle, AND slug exactly
            - Only change "EN" to "RO" in filename
            - Follow MARKETS.md localization requirements
            - Write natural Romanian, not literal translation
            - Update inLanguage to "ro" in Schema.org
            - NEVER run git commands

          claude_args: |
            --max-turns 25
            --model claude-opus-4-5-20251101
            --allowedTools "Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Upload final workspace
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: workspace-final
          path: |
            EN/
            DE/
            RO/
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Commit all articles and create PR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  commit-and-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: write-ro

    env:
      BRANCH_NAME: blog/auto-${{ github.run_id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Create working branch
        run: git checkout -b "$BRANCH_NAME"

      - name: Download final workspace
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: workspace-final
          path: .

      - name: Check for changes
        id: changes
        run: |
          STATUS="$(git status --porcelain)"
          if [ -z "$STATUS" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "::warning::No new files detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "âœ… New content detected:"
            echo "$STATUS"
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "blog: auto-generated posts $(date +%Y-%m-%d) [EN/DE/RO]"
          # Force push in case branch exists from a re-run
          git push --force-with-lease origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || echo "$GITHUB_TOKEN" | gh auth login --with-token

          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -n "$EXISTING_PR" ]; then
            echo "â„¹ï¸ PR #$EXISTING_PR already exists"
            exit 0
          fi

          FILE_LIST=$(git show --name-only --pretty="" HEAD)

          gh pr create \
            --title "ğŸ“ Blog: $(date +%Y-%m-%d) [EN/DE/RO]" \
            --body "## Auto-generated blog posts (3 languages)

**Branch:** \`${BRANCH_NAME}\`
**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

### Languages
- ğŸ‡¬ğŸ‡§ English (international)
- ğŸ‡©ğŸ‡ª German (DACH market)
- ğŸ‡·ğŸ‡´ Romanian (local market)

### Changed files
\`\`\`
${FILE_LIST}
\`\`\`

---
*Review all 3 versions before merging. Generated by BIOBUILDS blog engine.*" \
            --base "${{ github.event.repository.default_branch }}" \
            --head "$BRANCH_NAME"
